<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Badging API
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c-common" class=
    "remove"></script>
    <script class='remove'>
       var respecConfig = {
        xref: "web-platform",
        specStatus: "CG-DRAFT",
        edDraftURI: "https://wicg.github.io/badging/",
        github: {
          repoURL: "https://github.com/WICG/badging/",
          branch: "master"
        },
        shortName: "badging",
        processVersion: 2018,
        wg: "Web Incubator Community Group",
        wgURI: "https://wicg.io",
        editors: [{
          name: "Matt Giuca",
          company: "Google Inc.",
          companyURL: "https://google.com"
        }, {
          name: "Jay Harris",
          company: "Google Inc.",
          companyURL: "https://google.com"
        }],
        otherLinks: [{
          key: "Implementation status",
          data: [{
            value: "Chromium",
            href: "https://www.chromestatus.com/features/6068482055602176"
          }]
        }]
      };
    </script>
  </head>
  <body>
    <section id="abstract" class="informative">
      <p>
        This specification defines an API allowing web pages and <a data-cite=
        "appmanifest#installable-web-applications">web applications</a> to set
        a badge on the document, or an application-wide badge, shown in an
        operating-system-specific place associated with the application (such
        as the shelf or home screen), for the purpose of notifying the user
        when the state of the page or application has changed (e.g., when new
        messages have arrived), without showing a more heavyweight
        notification.
      </p>
    </section>
    <section id="sotd">
      <p>
        This is an early draft of the Badging API spec.
      </p>
    </section>
    <section class="informative">
      <h2>
        Usage examples
      </h2>
      <p>
        The following example shows how an email application might set a badge
        showing the unread count, which is updated whenever the client polls
        for mail from the server.
      </p>
      <p class="issue">
        Add examples of client/document badging.
      </p>
      <pre class="example javascript" title="Showing unread count">
        function pollForMail() {
          // ... Fetch unread mail from server. ...

          // Set the app icon badge. If getUnreadCount() returns 0, this is
          // equivalent to Badge.clear().
          navigator.setAppBadge(getUnreadCount());
        }
      </pre>
      <p>
        The next example shows how a game might show when it is the player's
        turn.
      </p>
      <pre class="example javascript" title="Showing ready status">
        function showPlayerTurn(playerTurnId) {
          if (playerTurnId === localPlayerId)
            navigator.setAppBadge();
          else
            navigator.clearAppBadge();
        }
      </pre>
    </section>
    <section>
      <h2>
        Badge model
      </h2>
      <p>
        A <dfn>badge</dfn> may be one of the following values:
      </p>
      <ul>
        <li>The special value <dfn>nothing</dfn>.
        </li>
        <li>The special value <dfn>flag</dfn>.
        </li>
        <li>An {{unsigned long long}}
       value, which MUST NOT be 0.
        </li>
      </ul>
      <p>
        Each [=document=] and each
        <a data-cite="appmanifest#installable-web-applications">web
        application</a> is associated with a <a>badge</a> value, which is
        initialized to <a>nothing</a>.
      </p>
      <p>
        The user agent MAY reset an application's badge to <a>nothing</a> at
        its discretion (for example, when the system is restarted).
      </p>
      <p>
        If a <a>badge</a> is <a>nothing</a>, it is said to be
        "<dfn>cleared</dfn>". Otherwise, it is said to be "<dfn>set</dfn>".
      </p>
    </section>
    <section>
      <h2>
        Badge display
      </h2>
      <p>
        When a document's badge is <a>set</a>, if the <a data-cite=
        "html#concept-document-bc">document's browsing context</a> is a
        <a data-cite="html#top-level-browsing-context">top-level browsing
        context</a>, the user agent SHOULD display the document's badge value
        alongside the other identifying information for that document (for
        example, on top of the document's icon or near its title).
      </p>
      <p class="issue">
        Perhaps the badge should be associated with a <a data-cite=
        "html#browsing-context">browsing context</a> instead of a <a data-cite=
        "dom#concept-document">document</a>.
      </p>
      <p class="note">
        The user agent is not expected to display a badge associated with a
        document that is not a <a data-cite=
        "html#top-level-browsing-context">top-level browsing context</a>,
        although it is allowed to. A user agent does not need to store the
        badge for a non-top-level browsing context if it does not intend to
        display it.
      </p>
      <p>
        When the application's badge is <a>set</a>, the user agent SHOULD
        display the application's badge alongside the symbolic representation
        of the application in the user's operating system (for example, as a
        small overlay on top of the application's icon).
      </p>
      <p>
        The special value <a>flag</a> indicates that the badge is set, but
        contains no specific data. In this case, the user agent SHOULD show an
        indicator with a non-specific symbol (such as a coloured circle).
      </p>
      <p>
        The user agent MAY simplify or degrade the data in any way. For
        example, a large integer may be saturated (for example, as "99+"). The
        font and formatting are entirely at the user agent's discretion. The
        user agent MAY ignore the data, and merely show a marker when the
        status is <a>set</a>.
      </p>
      <p>
        When presenting a badge, it SHOULD be formatted according to the user's
        <a data-cite="ltli/#locale">locale</a> settings. For example, the badge
        content '7' should be displayed as '7' in the <a data-cite=
        "ltli/#locale">locale</a> 'en-NZ' but as 'Ù§' in 'ar-EG'.
      </p>
    </section>
    <section>
      <h2>
        Extensions to the `Navigator` and `WorkerNavigator` interfaces
      </h2>
      <p>
        The {{Navigator}} and {{WorkerNavigator}} interfaces are extended with
        methods for setting and clearing both the document and application
        badge indicators from documents and service workers, respectively.
      </p>
      <pre class="idl">
        // Methods only exposed on documents.
        [SecureContext]
        partial interface Navigator {
          Promise&lt;void&gt; setClientBadge(optional [EnforceRange] unsigned long long contents);
          Promise&lt;void&gt; clearClientBadge();
        };

        // Methods exposed on both documents and service workers.
        [SecureContext]
        interface mixin NavigatorBadge {
          Promise&lt;void&gt; setAppBadge(optional [EnforceRange] unsigned long long contents);
          Promise&lt;void&gt; clearAppBadge();
        };

        Navigator includes NavigatorBadge;
        WorkerNavigator includes NavigatorBadge;
      </pre>
      <p>
        User agents that never display document badges SHOULD NOT expose the
        {{Navigator/setClientBadge()}} and {{Navigator/clearClientBadge()}}
        methods. Similarly, user agents that never display application badges
        SHOULD NOT expose the {{NavigatorBadge/setAppBadge}} and
        {{NavigatorBadge/clearAppBadge}} methods.
      </p>
      <p class="note">
        This is important as a feature-detection mechanism to allow sites to
        determine whether setting a badge will have any effect, based on the
        presence of the methods. In particular, sites can use the absence of
        {{Navigator/setClientBadge}} as a condition for displaying a fallback
        badge in the page's <a data-cite=
        "html#the-title-attribute"><code>title</code></a> or <a data-cite=
        "html#rel-icon"><code>icon</code></a>.
      </p>
      <p class="note">
        These methods return a {{Promise}}, even though there are no
        asynchronous failure conditions (the only failure conditions are WebIDL
        type errors). This is to allow us to add asynchronous failure
        conditions in the future without altering how type errors are returned.
      </p>
      <section>
        <h3>
          <dfn data-dfn-for="Navigator">setClientBadge()</dfn> method
        </h3>
        <p>
          When the {{Navigator/setClientBadge()}} method is called with argument
          <var>contents</var>, run the following steps:
        </p>
        <ol>
          <li>Let <var>document</var> be the <a data-cite=
          "html#current-settings-object">current settings object</a>'s
          <a data-cite="html#responsible-document">responsible document</a>.
          </li>
          <li>If <var>contents</var> is omitted, set the badge associated with
          <var>document</var> to <a>flag</a>.
          </li>
          <li>Else, if <var>contents</var> is 0, set the badge associated with
          <var>document</var> to <a>nothing</a>.
          </li>
          <li>Else, set the badge associated with <var>document</var> to <var>
            contents</var>.
          </li>
          <li>Return a <a data-cite="webidl#a-promise-resolved-with">resolved
          promise</a>.
          </li>
        </ol>
      </section>
      <section>
        <h3>
          <dfn data-dfn-for="Navigator">clearClientBadge()</dfn> method
        </h3>
        <p>
          When the <code>clearClientBadge()</code> method is called, set the
          the badge associated with the <a data-cite=
          "html#current-settings-object">current settings object</a>'s
          <a data-cite="html#responsible-document">responsible document</a> to
          <a>nothing</a>, and return a <a data-cite=
          "webidl#a-promise-resolved-with">resolved promise</a>.
        </p>
      </section>
      <section>
        <h3>
          <dfn data-dfn-for="NavigatorBadge">setAppBadge()</dfn> method
        </h3>
        <p>
          When the {{NavigatorBadge/setAppBadge()}} method is called with argument
          <var>contents</var>, run the following steps:
        </p>
        <ol>
          <li>Let <var>result</var> be the result of <a>determining the
          matching applications</a>. If <var>result</var> was a
          {{DOMException}}, return a <a data-cite=
          "webidl#a-promise-rejected-with">rejected promise</a> with reason
          <var>result</var>.
          </li>
          <li>For each <var>app</var> in <var>result</var>:
            <ol>
              <li>If <var>contents</var> is omitted, set the badge associated
              with <var>app</var> to <a>flag</a>.
              </li>
              <li>Else, if <var>contents</var> is 0, set the badge associated
              with <var>app</var> to <a>nothing</a>.
              </li>
              <li>Else, set the badge associated with <var>app</var> to
              <var>contents</var>.
              </li>
            </ol>
          </li>
          <li>Return a <a data-cite="webidl#a-promise-resolved-with">resolved
          promise</a>.
          </li>
        </ol>
      </section>
      <section>
        <h3>
          <dfn data-dfn-for="NavigatorBadge">clearAppBadge()</dfn> method
        </h3>
        <p>
          When the {{NavigatorBadge/clearAppBadge()}} method is called:
        </p>
        <ol>
          <li>Let <var>result</var> be the result of <a>determining the
          matching applications</a>. If <var>result</var> was a
          {{DOMException}}, return a <a data-cite=
          "webidl#a-promise-rejected-with">rejected promise</a> with reason
          <var>result</var>.
          </li>
          <li>For each <var>app</var> in <var>result</var>:
            <ol>
              <li>Set the badge associated with <var>app</var> to
              <a>nothing</a>.
              </li>
            </ol>
          </li>
          <li>Return a <a data-cite="webidl#a-promise-resolved-with">resolved
          promise</a>.
          </li>
        </ol>
      </section>
      <section>
        <h3>
          Determining the set of matching applications
        </h3>
        <div class="note">
          <p>
            This algorithm is used to decide which app(s) receive a badge when
            the {{NavigatorBadge/setAppBadge()}} method is called from various
            contexts.
          </p>
          <p>
            If called from a document context, the badge is applied to at most
            one application: the one with the most specific scope whose scope
            encloses this document URL.
          </p>
          <p>
            If called from a service worker context, the badge is applied to
            all applications whose scope sits within the service worker's
            scope.
          </p>
          <p>
            It is an error to call the API from a worker that is not a service
            worker.
          </p>
        </div>
        <p>
          The steps to <dfn data-lt=
          "determining the matching applications">determine the matching
          applications</dfn> returns a sequence of <a data-cite=
          "appmanifest#installable-web-applications">applications</a> or a
          {{DOMException}}:
        </p>
        <ol>
          <li>If <a data-cite="html#current-settings-object">current settings
          object</a> has a <a data-cite="html#responsible-document">responsible
          document</a> <var>document</var>:
            <ol>
              <li>Let <var>apps</var> be the <a data-cite="infra#ordered-set">
                set</a> of <a data-cite=
                "appmanifest#installable-web-applications">installed web
                applications</a> such that <var>document</var>'s <a data-cite=
                "dom#concept-document-url">URL</a> is <a data-cite=
                "appmanifest#dfn-within-scope-manifest">within scope</a> of the
                application's manifest. (Order is not important.)
              </li>
              <li>
                [=list/Remove=] all elements of
                <var>apps</var> other than the one with the longest (i.e., most
                specific) <a data-cite=
                "appmanifest#dfn-navigation-scope">navigation scope</a>.
              </li>
              <li>Return <var>apps</var>.
              </li>
            </ol>
          </li>
          <li>Otherwise, if the <a data-cite=
          "html#current-settings-object">current settings object</a> is a
          <a data-cite="service-workers-1#dfn-service-worker-client">service
          worker client</a> <var>worker</var>:
            <ol>
              <li>Return the <a data-cite="infra#ordered-set">set</a> of
              <a data-cite="appmanifest#installable-web-applications">installed
              web applications</a> whose <a data-cite=
              "appmanifest#dfn-navigation-scope">navigation scope</a> is
              <a data-cite="appmanifest#dfn-within-scope-manifest">within
              scope</a> (as defined in [[AppManifest]]) of <var>worker</var>'s
              <a data-cite=
              "service-workers-1#dfn-containing-service-worker-registration">containing
              service worker registration</a>'s <a data-cite=
              "service-workers-1#dfn-scope-url">scope url</a>. (Order is not
              important.)
              </li>
            </ol>
          </li>
          <li>Otherwise (this is a worker, but not a service worker), return a
          {{"NotSupportedError"}}.
          </li>
        </ol>
      </section>
    </section>
    <section class="informative">
      <h2>
        Security and privacy considerations
      </h2>
      <p>
        The API is write-only by design. There is no way for a site to read
        back the value of a badge that was previously set, to ensure that the
        application badge cannot be used as a storage or fingerprinting
        mechanism.
      </p>
    </section>
    <section>
      <h2>
        Dependencies
      </h2>
      <p>
        <code><dfn data-cite=
        "!ECMASCRIPT#sec-native-error-types-used-in-this-standard-typeerror">TypeError</dfn></code>
        is defined by [[ECMASCRIPT]].
      </p>
      <p>
        <code><dfn data-cite="!HTML#navigator">Navigator</dfn></code> and
        <code><dfn data-cite=
        "!HTML#workernavigator">WorkerNavigator</dfn></code> are defined by
        [[HTML]].
      </p>
    </section>
  </body>
</html>
